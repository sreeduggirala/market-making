name: Live Integration Tests

on:
  workflow_dispatch:
    inputs:
      adapters:
        description: "Run adapters live tests (kraken,mexc)"
        required: false
        default: "kraken"
      run_long_ws:
        description: "Enable long WS stability tests (ignored by default)"
        required: false
        default: "false"

jobs:
  live-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup environment
        run: |
          echo "ENABLE_LIVE_TESTS=true" >> $GITHUB_ENV
          if [ "${{ github.event.inputs.run_long_ws }}" = "true" ]; then echo "ENABLE_LONG_WS=true" >> $GITHUB_ENV; fi
        shell: bash

      - name: Inject secrets
        run: echo "Secrets are available as env in this job"
        env:
          KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
          KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
          MEXC_API_KEY: ${{ secrets.MEXC_API_KEY }}
          MEXC_API_SECRET: ${{ secrets.MEXC_API_SECRET }}

      - name: Run adapters live tests (kraken)
        if: contains(github.event.inputs.adapters, 'kraken')
        run: |
          cargo test --manifest-path crates/adapters/Cargo.toml --test kraken_live -- --nocapture
        env:
          ENABLE_LIVE_TESTS: true

      - name: Run adapters live tests (mexc)
        if: contains(github.event.inputs.adapters, 'mexc')
        run: |
          cargo test --manifest-path crates/adapters/Cargo.toml --test mexc_live -- --nocapture
        env:
          ENABLE_LIVE_TESTS: true

      - name: Run serde fixture tests
        run: |
          cargo test --manifest-path crates/adapters/Cargo.toml --test serde_fixtures
